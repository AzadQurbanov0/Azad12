<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coin KasasÄ±</title>
<style>
:root {
  --bg1: #0f0c29; --bg2: #302b63; --bg3: #24243e;
  --card: rgba(255,255,255,0.06); --glass: rgba(255,255,255,0.12);
  --text: #f8fafc; --text-muted: #a9a9a9;
  --accent: #22c55e; --red: #dc2626; --blue: #3b82f6; --purple: #8b5cf6; --diamond: #38bdf8;
  --yellow: #f59e0b;
  --blue-darker: #2563eb;
  --border-color: rgba(255,255,255,0.1);
}
[data-theme="light"] {
  --bg1: #f0f2f5; --bg2: #e4e6eb; --bg3: #dcdfe4;
  --card: rgba(255,255,255,0.8); --glass: rgba(0,0,0,0.05);
  --text: #1c1e21; --text-muted: #606770;
  --border-color: rgba(0,0,0,0.1);
}
*{box-sizing:border-box;margin:0;padding:0;}
html{height:100%;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji';
  color: var(--text); background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  min-height: 100vh; overflow-y: auto; padding-top: 70px; padding-bottom: 70px;
  transition: background-color 0.3s, color 0.3s;
}
.wrap{display:grid;place-items:center;gap:12px;text-align:center;padding:20px;}
.user-info{font-size:1rem;font-weight:600;opacity:.9;margin-bottom:6px; display:flex; align-items:center; gap: 10px;}
.settings-icon { font-size: 1.5rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s, transform 0.2s; }
.settings-icon:hover { opacity: 1; transform: rotate(45deg); }
.card{
  position:relative; width:min(60vw,320px); aspect-ratio:1/1; display:grid; place-items:center;
  background: radial-gradient(60% 60% at 50% 30%,var(--glass),transparent 70%),var(--card);
  border:1px solid var(--border-color); border-radius:24px;
  box-shadow:0 15px 40px rgba(0,0,0,0.35), inset 0 1px 0 var(--border-color);
  backdrop-filter:blur(6px); transition: background-color 0.3s, border 0.3s;
}
.bag{font-size:clamp(5rem,18vw,12rem);filter:drop-shadow(0 8px 15px rgba(0,0,0,0.35));user-select:none;animation:float 5s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
.balance{margin-top:10px;display:grid;place-items:center;font-weight:700;letter-spacing:1px;text-shadow:0 2px 5px rgba(0,0,0,0.5);}
.balance .symbol{font-size:clamp(1rem,2.5vw,1.5rem);opacity:.9;margin-right:4px;}
.balance .value{font-size:clamp(1.5rem,5vw,2.5rem);line-height:1;}
.google-btn{ margin-top:14px; padding:8px 16px; font-size:0.95rem; background:#4285F4; color:white; border:none; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:600;}
#notification-bell { position: fixed; top: 15px; left: 20px; font-size: 28px; cursor: pointer; user-select: none; z-index: 1000; }
#status-icon { position: fixed; top: 15px; left: 60px; font-size: 28px; cursor: pointer; user-select: none; z-index: 1000; }
#notification-badge { position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; width: 20px; height: 20px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
.modalOverlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; display:none; }
.modalContent{ background:linear-gradient(135deg,var(--bg1),var(--bg2)); padding:20px; border-radius:12px; text-align:center; color: var(--text); width: min(90vw, 350px); max-height: 90vh; display: flex; flex-direction: column; }
.modalContent button { margin-top:12px; padding:8px 16px; font-size:1rem; border:none; border-radius:8px; cursor:pointer; }
.content-wrapper { display:flex; flex-direction:column; flex-grow:1; opacity: 1; visibility: visible; transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out; width:100%; }
footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 5px 0; z-index: 1001; border-top: 1px solid var(--border-color); }
.nav-item { color: var(--text); text-decoration: none; text-align: center; font-size: 0.75rem; padding: 8px 12px; border-radius: 8px; transition: background 0.2s ease; cursor:pointer;}
.nav-item span { font-size: 1.5rem; display: block; }
.nav-item.active { background: rgba(255,255,255,0.2); font-weight: bold; }
.page { display: none; width: 100%; max-width: 500px; padding: 15px; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.page.active { display: block; }
#main-page.active { display: flex; flex-grow: 1; align-items: center; justify-content: center; }
.page-header { font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
#top-header { position: fixed; top: 0; left: 0; width: 100%; background: var(--card); backdrop-filter: blur(10px); z-index: 1001; padding: 10px 15px; display: none; justify-content: space-around; align-items: center; border-bottom: 1px solid var(--border-color); }
.header-balance { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.9rem; }
.header-balance span { font-size: 1.2rem; }
.page-list ul { list-style: none; padding: 0; width: 100%; }
.page-list li { background: var(--glass); padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 1rem; font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
.leaderboard-item-user { display: flex; align-items: center; gap: 10px; flex-grow: 1; text-align: left; }
.leaderboard-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0;}
.task-card { background: var(--card); border-left: 4px solid var(--purple); border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
.task-header { display: flex; justify-content: space-between; align-items: center; }
.task-title { font-size: 1.1rem; font-weight: 600; }
.task-reward { font-weight: bold; color: var(--diamond); }
.task-description { font-size: 0.9rem; color: var(--text-muted); text-align: left; }
.task-button { padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
.task-button.do { background-color: var(--purple); color: white; }
.task-button.pending { background-color: var(--yellow); color: var(--bg1); cursor: not-allowed; }
.task-button.completed { background-color: var(--accent); color: var(--bg1); cursor: not-allowed; }
.settings-card { width: 100%; padding: 20px; margin-bottom: 15px; background: var(--card); border: 1px solid var(--border-color); border-radius: 12px; }
.accordion { background-color: var(--card); color: var(--text); cursor: pointer; padding: 18px; width: 100%; border: none; text-align: left; outline: none; font-size: 1rem; font-weight: 600; transition: background-color 0.3s ease; border-radius: 8px; margin-bottom: 10px; }
.panel { padding: 0 18px; background-color: transparent; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; margin-bottom: 10px; }
.panel p { margin: 15px 0; line-height: 1.6; opacity: 0.9; }
/* YENI MINIK SEHIFESI UCUN STILLER */
.mining-card { background: var(--card); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: center; }
.mining-card-image { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin: 0 auto 10px; }
.mining-card h3 { font-size: 1.2rem; margin-bottom: 10px; }
.mining-card-stats { display: flex; justify-content: space-around; margin-bottom: 15px; font-size: 0.9rem; }
.mining-card-level { font-weight: bold; }
.mining-card-rate { color: var(--accent); font-weight: bold; }
.upgrade-info { font-size: 0.85rem; background: var(--glass); padding: 8px; border-radius: 6px; margin-bottom: 15px; }
.btn-upgrade { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; background: var(--blue); color: white; transition: background-color 0.2s; }
.btn-upgrade:disabled { background-color: var(--text-muted); cursor: not-allowed; }
</style>
</head>
<body>
	<div id="top-header">
    <div class="header-balance">hourly_rate<span id="header-rate-balance">0</span></div>
    <div class="header-balance">ğŸª™<span id="header-coin-balance">0</span></div>
    <div class="header-balance">ğŸ’<span id="header-gem-balance">0</span></div>
</div>

<div class="content-wrapper">
    <div id="notification-bell" style="display:none;"><span>ğŸ””</span><div id="notification-badge" style="display:none;"></div></div>
    <div id="status-icon" style="display:none;"><span>â„¹ï¸</span></div>

    <div id="main-page" class="page active">
        <main class="wrap">
            <div id="userInfo" class="user-info">
                <span id="user-greeting"></span>
                <span class="settings-icon" id="settingsBtn" style="display: none;">âš™ï¸</span>
            </div>
            <div class="card">
                <div class="bag" id="main-bag-icon">ğŸª™</div>
                <div class="balance">
                    <span id="balance" class="value">0.00</span>
                    <span class="symbol">COIN</span>
                </div>
            </div>
            <button class="google-btn" id="loginBtn">ğŸŒ GiriÅŸ</button>
        </main>
	</div>
     <div id="leaderboard-page" class="page">
        <h2 class="page-header">Saat KarÄ± SÄ±ralamasÄ±</h2>
        <div id="leaderboard-list" class="page-list">
            <ul></ul>
        </div>
    </div>

    <div id="tasks-page" class="page">
        <h2 class="page-header">TapÅŸÄ±rÄ±qlar</h2>
        <div id="tasks-container">
            <p style="text-align:center; color: var(--text-muted);">YÃ¼klÉ™nir...</p>
        </div>
	</div>
     <div id="mining-page" class="page">
        <h2 class="page-header">Minik</h2>
        <div id="mining-cards-container">
            <p style="text-align:center; color: var(--text-muted);">Kartlar yÃ¼klÉ™nir...</p>
        </div>
    </div>

    <div id="settings-page" class="page">
        <h2 class="page-header">Ayarlar</h2>
        <div class="settings-card profile-section">
            <img id="user-avatar" src="https://i.imgur.com/3YQ5h0Q.png" alt="Avatar" class="profile-avatar">
            <h3 id="user-display-name">YÃ¼klÉ™nir...</h3>
            <p id="user-email">YÃ¼klÉ™nir...</p>
        </div>
        <div class="settings-card settings-section">
            <div class="setting-item" id="help-section-in-settings" style="cursor: pointer;"><span>KÃ¶mÉ™k vÉ™ MÉ™lumat</span><span>></span></div>
            <div class="setting-item"><span>Versiya</span><span>3.0.0</span></div>
        </div>
        <div class="settings-card danger-zone">
            <button id="logoutBtn" class="btn-logout">Ã‡Ä±xÄ±ÅŸ Et</button>
        </div>
	</div>
     <div id="help-page" class="page">
        <h2 class="page-header">KÃ¶mÉ™k</h2>
        <button class="accordion">"Coin KasasÄ±" nÉ™dir?</button>
        <div class="panel"><p>Bu, istifadÉ™Ã§ilÉ™rin tapÅŸÄ±rÄ±qlar edÉ™rÉ™k vÉ™ "Minik" sistemindÉ™ kartlarÄ± inkiÅŸaf etdirÉ™rÉ™k virtual coin qazandÄ±ÄŸÄ± bir É™ylÉ™ncÉ™ platformasÄ±dÄ±r.</p></div>
        <button class="accordion">"Minik" nÉ™dir vÉ™ "Saat KarÄ±" nÉ™ demÉ™kdir?</button>
        <div class="panel"><p>"Minik" bÃ¶lmÉ™sindÉ™ kartlarÄ± coin ilÉ™ inkiÅŸaf etdirÉ™ bilÉ™rsiniz. HÉ™r kartÄ±n sÉ™viyyÉ™si artdÄ±qca, sizin Ã¼mumi "Saat KarÄ±"nÄ±z artÄ±r. "Saat KarÄ±" sizin hÉ™r saat offline olsanÄ±z belÉ™ avtomatik qazanacaÄŸÄ±nÄ±z coin miqdarÄ±dÄ±r.</p></div>
        <button class="accordion">NecÉ™ daha Ã§ox coin qazana bilÉ™rÉ™m?</button>
        <div class="panel"><p>"TapÅŸÄ±rÄ±qlar" bÃ¶lmÉ™sindÉ™ki tapÅŸÄ±rÄ±qlarÄ± yerinÉ™ yetirÉ™rÉ™k vÉ™ ya "Minik" bÃ¶lmÉ™sindÉ™ki kartlarÄ±n sÉ™viyyÉ™sini artÄ±raraq "Saat KarÄ±"nÄ±zÄ± yÃ¼ksÉ™ldÉ™rÉ™k daha Ã§ox coin qazana bilÉ™rsiniz.</p></div>
    </div>

    <div class="modalOverlay" id="notificationsModal"><div class="modalContent"><h3>Elanlar</h3><div id="announcements-container"></div><button class="close-modal-btn">BaÄŸla</button></div></div>
    <div class="modalOverlay" id="statusModal"><div class="modalContent"><h3>Sistem VÉ™ziyyÉ™ti</h3><div id="status-list"><p>MÉ™lumatlar yÃ¼klÉ™nir...</p></div><button class="close-modal-btn">BaÄŸla</button></div></div>
    <div class="modalOverlay" id="offline-earning-modal">
        <div class="modalContent">
            <h3>XoÅŸ GÉ™ldiniz!</h3>
            <p>Siz oyunda olmadÄ±ÄŸÄ±nÄ±z mÃ¼ddÉ™tdÉ™ <b id="earned-amount">0</b> ğŸª™ coin qazandÄ±nÄ±z!</p>
            <button class="close-modal-btn">Æla!</button>
        </div>
    </div>

</div>
<footer>
    <a class="nav-item active" id="homeBtn"><span>ğŸ </span>Æsas</a>
    <a class="nav-item" id="leaderboardBtn"><span>ğŸ…</span>LiderlÉ™r</a>
    <a class="nav-item" id="miningBtn"><span>â›ï¸</span>Minik</a>
    <a class="nav-item" id="tasksBtn"><span>ğŸ¯</span>TapÅŸÄ±rÄ±qlar</a>
</footer>

<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyC4sGTK_P4KperVswrxxmt69H5cocsgnNw", authDomain: "niceuc-e5986.firebaseapp.com", databaseURL: "https://niceuc-e5986-default-rtdb.firebaseio.com", projectId: "niceuc-e5986", appId: "1:242221260650:web:d140153a2167c4738dcf13" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    let listeners = {};
    let displayedCoinBalance = 0;
	    auth.onAuthStateChanged(user => {
        const topHeader = document.getElementById('top-header');
        const settingsBtn = document.getElementById('settingsBtn');
        if (user) {
            // Yeni istifadeci yoxlanisi ve baslangic bonuslar
            db.ref('user_coins/' + user.uid).once('value', snapshot => {
                if (!snapshot.exists()) {
                    db.ref('user_coins/' + user.uid).set({ amount: 5000 });
                    db.ref('user_mining_stats/' + user.uid).set({ totalRate: 0 });
                }
            });
            
            checkOfflineEarnings(user.uid);

            document.getElementById('user-greeting').textContent = `Salam, ${user.displayName}`;
            document.getElementById('loginBtn').style.display = 'none';
            settingsBtn.style.display = 'inline-block';
            topHeader.style.display = 'flex';
            
            db.ref('users/' + user.uid).update({ displayName: user.displayName, email: user.email, photoURL: user.photoURL });
            
            attachAllListeners(user.uid);
            
        } else {
            document.getElementById('user-greeting').textContent = 'XoÅŸ GÉ™lmisiniz!';
            document.getElementById('loginBtn').style.display = 'flex';
            settingsBtn.style.display = 'none';
            topHeader.style.display = 'none';
            document.getElementById('balance').textContent = '0.00';
            displayedCoinBalance = 0;
            detachAllListeners();
        }
    });

    async function checkOfflineEarnings(uid) {
        const statsRef = db.ref(`user_mining_stats/${uid}`);
        const snapshot = await statsRef.once('value');
        const stats = snapshot.val() || { totalRate: 0 };
        const lastLogin = stats.lastLogin || Date.now();
        const totalRate = stats.totalRate || 0;
        
        const now = Date.now();
        const diffHours = (now - lastLogin) / (1000 * 60 * 60);

        // 3 saatdan chox offlinedirsa
        if (diffHours > 3 && totalRate > 0) {
            const earnedAmount = Math.floor(diffHours * totalRate);
            if (earnedAmount > 0) {
                await db.ref(`user_coins/${uid}/amount`).set(firebase.database.ServerValue.increment(earnedAmount));
                document.getElementById('earned-amount').textContent = earnedAmount.toLocaleString();
                document.getElementById('offline-earning-modal').style.display = 'flex';
            }
        }
        
        // Son girishi yenile
        await statsRef.update({ lastLogin: now });
	}
	    function switchPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        switch (pageId) {
            case 'main-page':
                document.getElementById('homeBtn').classList.add('active');
                break;
            case 'leaderboard-page':
                document.getElementById('leaderboardBtn').classList.add('active');
                fetchMiningLeaderboard();
                break;
            case 'mining-page':
                document.getElementById('miningBtn').classList.add('active');
                initializeMiningPage();
                break;
            case 'tasks-page':
                document.getElementById('tasksBtn').classList.add('active');
                initializeTasksPage();
                break;
            case 'settings-page':
                initializeSettingsPage();
                break;
        }
    }

    document.getElementById('homeBtn').addEventListener('click', () => switchPage('main-page'));
    document.getElementById('leaderboardBtn').addEventListener('click', () => switchPage('leaderboard-page'));
    document.getElementById('miningBtn').addEventListener('click', () => switchPage('mining-page'));
    document.getElementById('tasksBtn').addEventListener('click', () => switchPage('tasks-page'));
    document.getElementById('settingsBtn').addEventListener('click', () => switchPage('settings-page'));
    document.getElementById('help-section-in-settings').addEventListener('click', () => switchPage('help-page'));

    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.closest('.modalOverlay').style.display = 'none';
        });
    });

    const accordions = document.getElementsByClassName("accordion");
    for (let i = 0; i < accordions.length; i++) {
        accordions[i].addEventListener("click", function() {
            this.classList.toggle("active");
            const panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
            } else {
                panel.style.maxHeight = panel.scrollHeight + "px";
            }
        });
    }

    function initializeSettingsPage() {
        const user = auth.currentUser;
        if (!user) return;
        document.getElementById('user-avatar').src = user.photoURL || 'https://i.imgur.com/3YQ5h0Q.png';
        document.getElementById('user-display-name').textContent = user.displayName;
        document.getElementById('user-email').textContent = user.email;
    }

    document.getElementById('logoutBtn').addEventListener('click', () => { 
        if(confirm("Hesabdan Ã§Ä±xmaq istÉ™diyinizÉ™ É™minsiniz?")) {
            auth.signOut().then(() => { 
                switchPage('main-page'); 
            }); 
        } 
    });
	    async function initializeMiningPage() {
        const container = document.getElementById('mining-cards-container');
        const user = auth.currentUser;
        if (!user) {
            container.innerHTML = '<p>ZÉ™hmÉ™t olmasa, giriÅŸ edin.</p>';
            return;
        }
        container.innerHTML = '<p>Kartlar yÃ¼klÉ™nir...</p>';

        const [cardsSnapshot, userCardsSnapshot, rulesSnapshot] = await Promise.all([
            db.ref('/mining_cards').once('value'),
            db.ref(`/user_cards/${user.uid}`).once('value'),
            db.ref('/card_level_rules').once('value')
        ]);

        if (!cardsSnapshot.exists()) {
            container.innerHTML = '<p>Aktiv minik kartÄ± tapÄ±lmadÄ±.</p>';
            return;
        }

        let html = '';
        const userCards = userCardsSnapshot.val() || {};
        const rules = rulesSnapshot.val() || {};

        cardsSnapshot.forEach(cardSnapshot => {
            const cardId = cardSnapshot.key;
            const cardData = cardSnapshot.val();
            const userCardData = userCards[cardId] || { level: 0 };
            const currentLevel = userCardData.level;
            
            const cardRules = rules[cardId] || {};
            const currentLevelRule = cardRules[currentLevel] || { hourly_rate_provided: 0 };
            const nextLevelRule = cardRules[currentLevel + 1];

            html += `
                <div class="mining-card">
                    <img src="${cardData.imageUrl}" alt="${cardData.name}" class="mining-card-image">
                    <h3>${cardData.name}</h3>
                    <div class="mining-card-stats">
                        <span class="mining-card-level">SÉ™viyyÉ™: ${currentLevel}</span>
                        <span class="mining-card-rate">+${currentLevelRule.hourly_rate_provided} hourly_rate/saat</span>
                    </div>
                    ${nextLevelRule ? `
                        <div class="upgrade-info">
                            NÃ¶vbÉ™ti SÉ™viyyÉ™ (+${nextLevelRule.hourly_rate_provided} hourly_rate/s) Ã¼Ã§Ã¼n qiymÉ™t: <b>${nextLevelRule.cost} ğŸª™</b>
                        </div>
                        <button class="btn-upgrade" onclick="upgradeCard('${cardId}')">Ä°nkiÅŸaf Etdir</button>
                    ` : `
                        <div class="upgrade-info">Maksimum sÉ™viyyÉ™yÉ™ Ã§atÄ±lÄ±b!</div>
                        <button class="btn-upgrade" disabled>Maksimum</button>
                    `}
                </div>
            `;
        });
        container.innerHTML = html;
    }

    async function upgradeCard(cardId) {
        const user = auth.currentUser;
        if (!user) return;

        const upgradeButton = event.target;
        upgradeButton.disabled = true;
        upgradeButton.textContent = 'YoxlanÄ±lÄ±r...';

        const userCardRef = db.ref(`/user_cards/${user.uid}/${cardId}`);
        const rulesRef = db.ref(`/card_level_rules/${cardId}`);
        const userCoinRef = db.ref(`/user_coins/${user.uid}/amount`);
        const userStatsRef = db.ref(`/user_mining_stats/${user.uid}/totalRate`);

        try {
            const [userCardSnapshot, rulesSnapshot, coinSnapshot] = await Promise.all([
                userCardRef.once('value'),
                rulesRef.once('value'),
                userCoinRef.once('value')
            ]);

            const userCard = userCardSnapshot.val() || { level: 0 };
            const rules = rulesSnapshot.val();
            const currentCoins = coinSnapshot.val() || 0;
            const currentLevel = userCard.level;
            
            const nextLevelRule = rules[currentLevel + 1];

            if (!nextLevelRule) {
                alert("Bu kart artÄ±q maksimum sÉ™viyyÉ™dÉ™dir.");
                return;
            }

            if (currentCoins < nextLevelRule.cost) {
                alert("KifayÉ™t qÉ™dÉ™r coin yoxdur!");
                initializeMiningPage(); // sehifeni yenile
                return;
            }

            // Evvelki seviyyenin verdiyi rate
            const previousRate = rules[currentLevel] ? rules[currentLevel].hourly_rate_provided : 0;
            const rateIncrease = nextLevelRule.hourly_rate_provided - previousRate;

            // Transaction
            await userCoinRef.set(firebase.database.ServerValue.increment(-nextLevelRule.cost));
            await userCardRef.update({ level: currentLevel + 1 });
            await userStatsRef.set(firebase.database.ServerValue.increment(rateIncrease));
            
            alert(`${rules.cardName || 'Kart'} uÄŸurla ${currentLevel + 1}-ci sÉ™viyyÉ™yÉ™ yÃ¼ksÉ™ldi!`);

        } catch (error) {
            console.error("Upgrade error: ", error);
            alert("XÉ™ta baÅŸ verdi. ZÉ™hmÉ™t olmasa, yenidÉ™n cÉ™hd edin.");
        } finally {
            initializeMiningPage(); // Neticeni gostermek uchun sehifeni yenile
        }
	}
	    async function fetchMiningLeaderboard() { 
        const listContainer = document.getElementById('leaderboard-list');
        listContainer.innerHTML = "<ul><li>YÃ¼klÉ™nir...</li></ul>"; 
        
        try {
            const statsSnapshot = await db.ref('user_mining_stats').orderByChild('totalRate').limitToLast(50).once('value'); 
            
            if (!statsSnapshot.exists()) {
                listContainer.innerHTML = "<ul><li>SÄ±ralama Ã¼Ã§Ã¼n kifayÉ™t qÉ™dÉ™r istifadÉ™Ã§i yoxdur.</li></ul>";
                return;
            }
            
            let users = [];
            statsSnapshot.forEach(child => {
                users.push({ uid: child.key, ...child.val() });
            });
            
            users.sort((a, b) => b.totalRate - a.totalRate); 
            
            const userInfoPromises = users.map(user => db.ref(`users/${user.uid}`).once('value'));
            const usersInfoSnapshots = await Promise.all(userInfoPromises);
            
            let listHTML = '<ul>';
            users.forEach((user, index) => {
                const userData = usersInfoSnapshots[index].val() || {};
                const photoURL = userData.photoURL || 'https://i.imgur.com/3YQ5h0Q.png';
                const displayName = userData.displayName || "NamÉ™lum";
                
                listHTML += `
                    <li>
                        <div class="leaderboard-item-user">
                            <img src="${photoURL}" class="leaderboard-avatar">
                            <span><b>#${index + 1}</b> ${displayName}</span>
                        </div>
                        <span>${user.totalRate} hourly_rate/saat</span>
                    </li>`;
            });
            
            listHTML += '</ul>';
            listContainer.innerHTML = listHTML;
        } catch (error) {
            console.error("Leaderboard error:", error);
            listContainer.innerHTML = "<ul><li>LiderlÉ™r cÉ™dvÉ™lini yÃ¼klÉ™mÉ™k mÃ¼mkÃ¼n olmadÄ±.</li></ul>";
        }
		}
	    async function initializeTasksPage() {
        const tasksContainer = document.getElementById('tasks-container');
        const user = auth.currentUser;
        if (!user) return;

        const [tasksSnapshot, submissionsSnapshot] = await Promise.all([
            db.ref('/tasks').once('value'),
            db.ref(`/task_submissions/${user.uid}`).once('value')
        ]);

        if (!tasksSnapshot.exists()) {
            tasksContainer.innerHTML = "<p>HazÄ±rda aktiv tapÅŸÄ±rÄ±q yoxdur.</p>";
            return;
        }

        let tasksHTML = '';
        const submissions = submissionsSnapshot.val() || {};
        tasksSnapshot.forEach(taskSnapshot => {
            const taskId = taskSnapshot.key;
            const task = taskSnapshot.val();
            const status = submissions[taskId]?.status || 'new';

            let btnHTML;
            switch (status) {
                case 'pending':
                    btnHTML = `<button class="task-button pending" disabled>YoxlanÄ±lÄ±r</button>`;
                    break;
                case 'completed':
                    btnHTML = `<button class="task-button completed" disabled>TamamlandÄ±</button>`;
                    break;
                default:
                    btnHTML = `<button class="task-button do" onclick="doTask('${taskId}', '${task.link}')">TapÅŸÄ±rÄ±ÄŸÄ± Et</button>`;
            }

            let rewardIcon = '';
            if (task.reward_type === 'gems') rewardIcon = 'ğŸ’';
            else if (task.reward_type === 'coin') rewardIcon = 'ğŸª™';
            else rewardIcon = 'XP';

            tasksHTML += `
                <div class="task-card">
                    <div class="task-header">
                        <span class="task-title">${task.title}</span>
                        <span class="task-reward">+${task.reward_amount} ${rewardIcon}</span>
                    </div>
                    <p class="task-description">${task.description}</p>
                    ${btnHTML}
                </div>`;
        });
        tasksContainer.innerHTML = tasksHTML;
    }

    function doTask(taskId, link) {
        if (confirm("Bu tapÅŸÄ±rÄ±ÄŸÄ± etmÉ™k Ã¼Ã§Ã¼n kÉ™nar sÉ™hifÉ™yÉ™ yÃ¶nlÉ™ndirilÉ™cÉ™ksiniz. Davam edilsin?")) {
            window.open(link, '_blank');
            const user = auth.currentUser;
            db.ref(`/task_submissions/${user.uid}/${taskId}`).set({
                status: 'pending',
                submittedAt: firebase.database.ServerValue.TIMESTAMP
            });
            initializeTasksPage();
        }
	}
	    function attachAllListeners(uid) {
        detachAllListeners();
        
        listeners['coins'] = db.ref('user_coins/' + uid).on('value', snapshot => {
            const coinAmount = snapshot.val()?.amount || 0;
            const coinText = Math.floor(coinAmount).toLocaleString();
            
            document.getElementById('balance').textContent = coinText;
            const headerCoinEl = document.getElementById('header-coin-balance');
            if (headerCoinEl) headerCoinEl.textContent = coinText;
        });

        listeners['gems'] = db.ref('user_gems/' + uid).on('value', snapshot => {
            const gemEl = document.getElementById('header-gem-balance');
            if (gemEl) gemEl.textContent = snapshot.val()?.amount || 0;
        });
        
        listeners['mining_stats'] = db.ref('user_mining_stats/' + uid).on('value', snapshot => {
            const rate = snapshot.val()?.totalRate || 0;
            const headerRateEl = document.getElementById('header-rate-balance');
            if(headerRateEl) headerRateEl.textContent = rate;
        });
    }

    function detachAllListeners() {
        for (const key in listeners) {
            if (listeners[key]) {
                db.ref(listeners[key].path).off('value', listeners[key].callback);
            }
        }
        listeners = {};
    }

</script>
</body>
</html>
