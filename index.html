<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Para Tƒ±klama Oyunu</title>
<style>
:root {
  --bg1: #1e1c45; --bg2: #2f2c61; --bg3: #1a1936;
  --card: rgba(255,255,255,0.06); --glass: rgba(255,255,255,0.12);
  --text: #f8fafc; --text-muted: #d1d5db;
  --accent: #22c55e; --purple: #8b5cf6;
  --yellow: #f59e0b;
  --border-color: rgba(255,255,255,0.1);
  --energy-color: #facc15; /* Enerji √º√ß√ºn sarƒ± r…ông */
  --clicker-bg: #4a45a3;
  --clicker-shadow: #312e6d;
}
*{box-sizing:border-box;margin:0;padding:0; font-family: system-ui, -apple-system, sans-serif;}
html, body {
    height: 100%;
    overflow: hidden;
}
body{
  color: var(--text); background: linear-gradient(135deg, var(--bg1), var(--bg2) 50%, var(--bg3));
  display: flex; flex-direction: column; align-items: center; justify-content: space-between;
  text-align: center;
  user-select: none;
}
.hidden { display: none !important; }

.game-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding-bottom: 75px; /* Footer √º√ß√ºn bo≈üluq */
}

.page { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; padding: 15px; animation: fadeIn 0.5s ease; }
.page.active { display: flex; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
<style>
#main-page {
    justify-content: center;
    text-align: center;
}
.user-greeting {
    font-size: 1.1rem;
    font-weight: 500;
    opacity: .8;
    margin-top: 20px;
    margin-bottom: 25px;
}

/* ≈û…ôkild…ôki dizayna uyƒüun yeni balans stili */
.balance-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
}
.balance-icon img {
    width: 30px;
    height: 30px;
    margin-bottom: 8px;
}
.balance-value {
    font-size: clamp(3rem, 13vw, 4.5rem);
    font-weight: 700;
    line-height: 1;
}

.clickable-area {
    width: min(70vw, 290px);
    aspect-ratio: 1/1;
    border-radius: 50%;
    display: grid;
    place-items: center;
    cursor: pointer;
    background: var(--clicker-bg);
    box-shadow: 0 10px 0 var(--clicker-shadow), 0 15px 30px rgba(0,0,0,0.3);
    transition: transform 0.1s ease, box-shadow 0.1s ease;
}
.clickable-area:active {
    transform: translateY(5px);
    box-shadow: 0 5px 0 var(--clicker-shadow), 0 10px 20px rgba(0,0,0,0.3);
}
.clickable-area .icon {
    font-size: clamp(5rem, 25vw, 10rem);
    filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
    transform: translateY(-5px); /* ƒ∞konu bir az yuxarƒ± √ß…ôkir */
}

/* Enerji v…ô G…ôlir Still…ôri */
.game-stats {
    margin-top: 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
    font-weight: 600;
}
.energy-text {
    display: flex;
    align-items: center;
    gap: 8px;
}
.profit-display {
    font-size: 0.9rem;
    color: var(--text-muted);
}
</style>
<style>
/* Birja/Yenil…ôm…ôl…ôr S…ôhif…ôsi */
.page-header { font-size: 1.8rem; font-weight: 700; margin-bottom: 20px; }
.tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
.tab { padding: 10px 20px; cursor: pointer; font-size: 1rem; font-weight: bold; color: var(--text-muted); border-bottom: 3px solid transparent; }
.tab.active { color: var(--text); border-bottom-color: var(--accent); }
#upgrade-cards-container { width: 100%; max-width: 500px; height: calc(100% - 150px); overflow-y: auto; padding: 5px; display: flex; flex-direction: column; gap: 12px; }
.upgrade-card { background: var(--card); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; text-align: left; }
.upgrade-card .icon { font-size: 2.5rem; }
.upgrade-card .details { flex-grow: 1; }
.upgrade-card .name { font-weight: 600; font-size: 1.1rem; }
.upgrade-card .meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
.upgrade-card .price { font-weight: bold; color: var(--yellow); }
.btn-upgrade { padding: 10px 18px; border: none; border-radius: 8px; background: var(--accent); color: white; font-weight: bold; cursor: pointer; }
.btn-upgrade:disabled { background-color: #555; cursor: not-allowed; }

/* Footer */
footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg3); display: flex; justify-content: space-around; padding: 10px 0; z-index: 1001; border-top: 1px solid var(--border-color); }
.nav-item { color: var(--text); text-decoration: none; text-align: center; font-size: 0.8rem; padding: 4px 12px; border-radius: 8px; cursor:pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; opacity: 0.7; }
.nav-item .icon { font-size: 1.8rem; display: block; }
.nav-item.active { opacity: 1; font-weight: bold; }

/* Modal */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px); }
.modal-content { background: linear-gradient(135deg,var(--bg1),var(--bg2)); padding: 30px; border-radius: 12px; text-align: center; color: var(--text); width: min(90vw, 350px); }
.modal-content h3 { margin-bottom: 15px; }
.modal-content p { margin-bottom: 25px; line-height: 1.5; }
.modal-button { padding: 10px 20px; font-size:1rem; border:none; border-radius:8px; cursor:pointer; background: var(--accent); color: white; }
</style>
</head>
<body>
  <div class="game-container">
    <div id="main-page" class="page active">
        <div class="user-greeting" id="user-greeting-text">Y√ºkl…ônir...</div>

        <div class="balance-display">
             <div class="balance-icon">
                <img src="https://i.imgur.com/aJ3Ew2s.png" alt="Coin">
            </div>
            <div class="balance-value" id="balance">0</div>
        </div>

        <div class="clickable-area" id="clickable-area">
            <div class="icon">üí∞</div>
        </div>

        <div class="game-stats">
            <div class="energy-text">
                ‚ö° <span id="energy-text-value">0/0</span>
            </div>
            <div class="profit-display">
                Saatlƒ±q g…ôlir: <span id="profit-per-hour">0</span>
            </div>
        </div>
    </div>
        <div id="birja-page" class="page">
        <h2 class="page-header">Yenil…ôm…ôl…ôr</h2>
        <div class="tabs">
            <div class="tab active" data-category="pr_team">PR & Team</div>
            <div class="tab" data-category="markets">Markets</div>
            <div class="tab" data-category="legal">Legal</div>
            <div class="tab" data-category="specials">Specials</div>
        </div>
        <div id="upgrade-cards-container">
            <p>Y√ºkl…ônir...</p>
        </div>
    </div>
    
    <div id="leaderboard-page" class="page">
         <h2 class="page-header">Liderl…ôr C…ôdv…ôli</h2>
         <p>Tezlikl…ô...</p>
    </div>

</div> ```

<footer>
    <a class="nav-item active" data-page="main-page"><span class="icon">üí∞</span>Oyun</a>
    <a class="nav-item" data-page="birja-page"><span class="icon">üìà</span>Birja</a>
    <a class="nav-item" data-page="leaderboard-page"><span class="icon">üèÖ</span>Liderl…ôr</a>
</footer>

<div class="modal-overlay hidden" id="offline-earnings-modal">
    <div class="modal-content">
        <h3>Xo≈ü G…ôldin!</h3>
        <p id="offline-earnings-text">Siz oyunda olmadƒ±ƒüƒ±nƒ±z m√ºdd…ôtd…ô qazanc …ôld…ô etdiniz!</p>
        <button class="modal-button" id="close-modal-btn">∆èla!</button>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
const firebaseConfig = {
    // BURAYA √ñZ FIREBASE KONFƒ∞QURASƒ∞YA M∆èLUMATLARINIZI YAPI≈ûDIRIN
    apiKey: "AIza...",
    authDomain: "....firebaseapp.com",
    databaseURL: "https://....firebasedatabase.app",
    projectId: "...",
    storageBucket: "....appspot.com",
    messagingSenderId: "...",
    appId: "..."
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tg = window.Telegram.WebApp;

// Global Variables
let currentUser = null;
let userProfile = {};
let gameCards = {};
let energyInterval = null;
const ENERGY_REGEN_RATE_PER_SECOND = 1; // Saniy…ôd…ô 1 enerji
const OFFLINE_EARNINGS_CAP_HOURS = 3;

// UI Elements
const balanceEl = document.getElementById('balance');
const energyTextEl = document.getElementById('energy-text-value');
const profitPerHourEl = document.getElementById('profit-per-hour');
const clickableArea = document.getElementById('clickable-area');
const greetingEl = document.getElementById('user-greeting-text');
const upgradeCardsContainer = document.getElementById('upgrade-cards-container');
</script>
document.addEventListener('DOMContentLoaded', () => {
    tg.ready();
    tg.expand();

    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        currentUser = tg.initDataUnsafe.user;
        initGame(currentUser);
    } else {
        greetingEl.textContent = "L√ºtf…ôn, Telegram il…ô daxil olun.";
    }
});

async function initGame(user) {
    greetingEl.textContent = user.first_name || "Y√ºkl…ônir...";
    
    const userRef = db.ref(`users/${user.id}`);
    const userSnapshot = await userRef.once('value');

    if (!userSnapshot.exists()) {
        await handleNewUser(user);
    }

    await loadGameData(user.id);
    await calculatePassiveIncome(user.id);
    await loadUpgradeCards();

    attachFirebaseListeners(user.id);
    startEnergyRegen(user.id);
    attachUIListeners();
}

async function handleNewUser(user) {
    const initialProfile = {
        info: { id: user.id, first_name: user.first_name, username: user.username || '' },
        game_data: { coins: 5000, energy_max: 500, energy_current: 500, profit_per_hour: 0, last_active: firebase.database.ServerValue.TIMESTAMP },
        purchased_cards: {}
    };
    await db.ref(`users/${user.id}`).set(initialProfile);
}

async function loadGameData(uid) {
    const snapshot = await db.ref(`users/${uid}/game_data`).once('value');
    userProfile = snapshot.val() || {};
    userProfile.coins = userProfile.coins || 0;
    userProfile.energy_max = userProfile.energy_max || 500;
    userProfile.energy_current = userProfile.energy_current ?? 500;
    userProfile.profit_per_hour = userProfile.profit_per_hour || 0;
    updateUI();
}
  async function calculatePassiveIncome(uid) {
    const now = Date.now();
    const lastActive = userProfile.last_active || now;
    const secondsPassed = Math.floor((now - lastActive) / 1000);
    
    const maxSeconds = OFFLINE_EARNINGS_CAP_HOURS * 3600;
    const secondsToCalculate = Math.min(secondsPassed, maxSeconds);

    if (secondsToCalculate > 60 && userProfile.profit_per_hour > 0) {
        const profitPerSecond = userProfile.profit_per_hour / 3600;
        const earnings = Math.floor(profitPerSecond * secondsToCalculate);

        if (earnings > 0) {
            await db.ref(`users/${uid}/game_data/coins`).set(firebase.database.ServerValue.increment(earnings));
            
            document.getElementById('offline-earnings-text').textContent = 
                `Siz oyunda olmadƒ±ƒüƒ±nƒ±z m√ºdd…ôtd…ô ${earnings.toLocaleString()} coin qazandƒ±nƒ±z!`;
            document.getElementById('offline-earnings-modal').classList.remove('hidden');
        }
    }
    
    await db.ref(`users/${uid}/game_data/last_active`).set(now);
}

function attachFirebaseListeners(uid) {
    db.ref(`users/${uid}/game_data`).on('value', (snapshot) => {
        userProfile = snapshot.val() || {};
        updateUI();
    });
}

function startEnergyRegen(uid) {
    if (energyInterval) clearInterval(energyInterval);
    
    energyInterval = setInterval(() => {
        if (userProfile.energy_current < userProfile.energy_max) {
            const newEnergy = Math.min(userProfile.energy_max, userProfile.energy_current + 1);
            if(newEnergy > userProfile.energy_current){
                 db.ref(`users/${uid}/game_data/energy_current`).set(newEnergy);
            }
        }
    }, 1000 / ENERGY_REGEN_RATE_PER_SECOND);
}
          function handleTap() {
    if (userProfile.energy_current > 0) {
        const tapValue = 1;
        
        userProfile.coins += tapValue;
        userProfile.energy_current -= 1;
        updateUI();

        const updates = {};
        updates[`users/${currentUser.id}/game_data/coins`] = firebase.database.ServerValue.increment(tapValue);
        updates[`users/${currentUser.id}/game_data/energy_current`] = firebase.database.ServerValue.increment(-1);
        updates[`users/${currentUser.id}/game_data/last_active`] = Date.now();
        db.ref().update(updates);
    }
}

async function purchaseUpgrade(cardId) {
    const card = gameCards[cardId];
    const userCardSnapshot = await db.ref(`users/${currentUser.id}/purchased_cards/${cardId}`).once('value');
    const userCardLevel = userCardSnapshot.val()?.level || 0;

    if(userCardLevel >= card.max_level) return;

    const cost = Math.floor(card.cost_base * Math.pow(card.cost_factor, userCardLevel));

    if (userProfile.coins >= cost) {
        const profitIncrease = card.profit_base;

        const updates = {};
        updates[`users/${currentUser.id}/game_data/coins`] = firebase.database.ServerValue.increment(-cost);
        updates[`users/${currentUser.id}/purchased_cards/${cardId}/level`] = firebase.database.ServerValue.increment(1);
        updates[`users/${currentUser.id}/game_data/profit_per_hour`] = firebase.database.ServerValue.increment(profitIncrease);
        
        await db.ref().update(updates);
        renderUpgradeCards(); 
    } else {
        alert("Kifay…ôt q…ôd…ôr coin yoxdur!");
    }
}
          function updateUI() {
    balanceEl.textContent = Math.floor(userProfile.coins || 0).toLocaleString();
    profitPerHourEl.textContent = (userProfile.profit_per_hour || 0).toLocaleString();
    energyTextEl.textContent = `${Math.floor(userProfile.energy_current || 0)}/${userProfile.energy_max || 500}`;
}

async function loadUpgradeCards() {
    const snapshot = await db.ref('upgrade_cards').once('value');
    gameCards = snapshot.val() || {};
    await renderUpgradeCards();
}

async function renderUpgradeCards() {
    if (!upgradeCardsContainer) return;
    upgradeCardsContainer.innerHTML = '';
    const activeCategory = document.querySelector('.tab.active').dataset.category;
    
    const userCardsSnapshot = await db.ref(`users/${currentUser.id}/purchased_cards`).once('value');
    const userCards = userCardsSnapshot.val() || {};

    for (const cardId in gameCards) {
        const card = gameCards[cardId];
        if(card.category !== activeCategory) continue;

        const userCardLevel = userCards[cardId]?.level || 0;
        const cost = Math.floor(card.cost_base * Math.pow(card.cost_factor, userCardLevel));

        const cardHTML = `
            <div class="upgrade-card">
                <div class="icon">${card.emoji}</div>
                <div class="details">
                    <div class="name">${card.name}</div>
                    <div class="meta">
                        <span>S…ôviyy…ô: ${userCardLevel}</span> | 
                        <span>G…ôlir: +${card.profit_base}/saat</span>
                    </div>
                    <div class="price">Qiym…ôt: ${cost.toLocaleString()}</div>
                </div>
                <button class="btn-upgrade" data-card-id="${cardId}" ${userCardLevel >= card.max_level ? 'disabled' : ''}>
                    ${userCardLevel >= card.max_level ? 'MAX' : 'Al'}
                </button>
            </div>
        `;
        upgradeCardsContainer.innerHTML += cardHTML;
    }
}
          function attachUIListeners() {
    clickableArea.addEventListener('click', handleTap);

    document.getElementById('close-modal-btn').addEventListener('click', () => {
        document.getElementById('offline-earnings-modal').classList.add('hidden');
    });

    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            const pageId = e.currentTarget.dataset.page;
            switchPage(pageId);
        });
    });

    upgradeCardsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-upgrade')) {
            const cardId = e.target.dataset.cardId;
            purchaseUpgrade(cardId);
        }
    });
    
    document.querySelectorAll('.tabs .tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            e.currentTarget.classList.add('active');
            renderUpgradeCards();
        });
    });
}

function switchPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');

    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === pageId);
    });
}
</script>
</body>
</html>
